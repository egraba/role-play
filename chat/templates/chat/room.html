{% extends 'base.html' %}

{% block content %}
    <div class="rpgui-container framed">
        <h1 id="title" class="title">{{ room.game }}</h1>
        <div class="rpgui-center">
            <a href={% url 'game' room.game.id %}>- Return to the game -</a>
        </div>
        <p>
            <label>Chat:</label>
            <textarea id="chat"></textarea>
        </p>
        <p>
            <label>Message:</label>
            <input id="chat-message-input" type="text">
        </p>
        <div class="rpgui-center">
            <button id="chat-message-submit" class="rpgui-button" type="submit"><p>Send</p></button>
        </div>

        <script>
            const url = 'ws://' + window.location.host + '/ws/chat/' + {{ room.id }} + '/';
            const chatSocket = new WebSocket(url);

            chatSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const chat = document.getElementById('chat');
                chat.innerHTML += data.user + ': (' + data.datetime + ')\n' + data.message + '\n';
                chat.scrollTop = chat.scrollHeight;
            };

            chatSocket.onclose = function(event) {
                console.error('Chat socket closed unexpectedly');
            };

            const input = document.getElementById('chat-message-input');
            const submitButton = document.getElementById('chat-message-submit');

            submitButton.addEventListener('click', function(event) {
                const message = input.value;
                if (message) {
                    chatSocket.send(JSON.stringify({
                        'message': message
                    }));
                    input.value = '';
                    input.focus();
                }
            });

            input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    submitButton.click();
                }
            });
            input.focus();

        </script>
    </div>
{% endblock %}
