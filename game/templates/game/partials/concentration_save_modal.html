<div id="concentration-save-modal" class="rpg-modal {% if show_modal %}active{% endif %}">
    <div class="modal-content">
        <button class="modal-close" onclick="closeConcentrationModal()" type="button">&times;</button>

        {% if not show_result %}
            <div class="modal-header">Concentration Check</div>

            <div style="font-size: 13px; margin-bottom: 16px;">
                <strong>{{ character.name }}</strong> must make a Constitution save
                to maintain <strong>{{ concentration.spell.name }}</strong>.
            </div>

            <div style="display: flex; flex-direction: column; gap: 6px; font-size: 13px; margin-bottom: 16px;">
                <div class="flex-between">
                    <span class="text-muted">Damage taken</span>
                    <span style="color: var(--red);">{{ damage }}</span>
                </div>
                <div class="flex-between">
                    <span class="text-muted">Save DC</span>
                    <span style="font-weight: 600; color: var(--text);">{{ dc }}</span>
                </div>
                <div class="flex-between">
                    <span class="text-muted">Constitution modifier</span>
                    <span>{% if con_modifier >= 0 %}+{% endif %}{{ con_modifier }}</span>
                </div>
            </div>

            <form hx-post="{% url 'concentration-save-roll' game.id character.pk %}"
                  hx-target="#concentration-save-modal"
                  hx-swap="outerHTML">
                <input type="hidden" name="dc" value="{{ dc }}">
                <input type="hidden" name="con_modifier" value="{{ con_modifier }}">
                <div class="flex-end gap-8">
                    <button type="button" class="btn btn-ghost" onclick="closeConcentrationModal()">Skip</button>
                    <button type="submit" class="btn btn-primary">Roll Save</button>
                </div>
            </form>

        {% else %}
            <div class="modal-header">
                {% if success %}Concentration Maintained{% else %}Concentration Lost{% endif %}
            </div>

            <div style="text-align: center; padding: 8px 0 16px;">
                <div class="text-mono"
                     style="font-size: 48px; font-weight: 700; color: {% if success %}var(--green){% else %}var(--red){% endif %}; line-height: 1;">
                    {{ roll }}
                </div>
                <div class="text-muted" style="font-size: 13px; margin-top: 8px;">
                    {{ roll }} {% if con_modifier >= 0 %}+{% endif %}{{ con_modifier }} =
                    <strong style="color: var(--text);">{{ total }}</strong>
                    vs DC {{ dc }}
                </div>
                <div style="margin-top: 12px;">
                    {% if is_natural_20 %}
                        <span class="badge badge-green" style="font-size: 14px; padding: 4px 12px;">NATURAL 20!</span>
                    {% elif is_natural_1 %}
                        <span class="badge badge-red" style="font-size: 14px; padding: 4px 12px;">NATURAL 1</span>
                    {% elif success %}
                        <span class="badge badge-green" style="font-size: 14px; padding: 4px 12px;">SUCCESS</span>
                    {% else %}
                        <span class="badge badge-red" style="font-size: 14px; padding: 4px 12px;">FAILED</span>
                    {% endif %}
                </div>
                <div class="text-muted" style="font-size: 12px; margin-top: 8px;">
                    {% if success %}
                        {{ character.name }} maintains concentration on {{ spell_name }}.
                    {% else %}
                        {{ character.name }} has lost concentration on {{ spell_name }}.
                    {% endif %}
                </div>
            </div>

            <div class="flex-end" style="padding-top: 16px; border-top: 1px solid var(--border);">
                <button type="button" class="btn btn-ghost" onclick="closeConcentrationModal()">Close</button>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function closeConcentrationModal() {
        const modal = document.getElementById('concentration-save-modal');
        if (modal) modal.classList.remove('active');
        htmx.trigger(document.body, 'concentration-modal-closed');
    }
</script>
