<div id="attack-modal" class="rpg-modal {% if show_modal %}active{% endif %}">
    <div class="modal-content">
        <button class="modal-close" onclick="closeAttackModal()" type="button">&times;</button>

        {% if not attack_result %}
        <!-- Step 1: Setup -->
            <div class="modal-header">Attack</div>
            <form id="attack-form"
                  hx-post="{% url 'combat-attack-roll' game.id combat.id %}"
                  hx-target="#attack-modal"
                  hx-swap="outerHTML">

                <div class="form-group">
                    <label>Select Target</label>
                    <select name="target_id" class="rpg-select target-select" required>
                        <option value="">— choose a target —</option>
                        {% for fighter in targets %}
                            <option value="{{ fighter.id }}"
                                    {% if selected_target == fighter.id %}selected{% endif %}>
                                {{ fighter.character.name }} (AC {{ fighter.character.ac|default:"10" }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Weapon</label>
                    <select name="weapon_id" class="rpg-select" required>
                        {% for wd in weapons %}
                            <option value="{{ wd.weapon.id }}"
                                    data-attack-bonus="{{ wd.attack_bonus }}"
                                    data-damage="{{ wd.damage }}">
                                {{ wd.weapon.settings.name }} ({{ wd.damage }}, +{{ wd.attack_bonus }})
                            </option>
                        {% empty %}
                            <option value="">— no weapons equipped —</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Modifier</label>
                    <div class="toggle-group">
                        <button type="button"
                                class="btn btn-ghost {% if roll_modifier == 'disadvantage' %}active{% endif %}"
                                data-value="disadvantage"
                                onclick="setRollModifier(this, 'disadvantage')">Disadvantage</button>
                        <button type="button"
                                class="btn btn-ghost {% if roll_modifier == 'normal' or not roll_modifier %}active{% endif %}"
                                data-value="normal"
                                onclick="setRollModifier(this, 'normal')">Normal</button>
                        <button type="button"
                                class="btn btn-ghost {% if roll_modifier == 'advantage' %}active{% endif %}"
                                data-value="advantage"
                                onclick="setRollModifier(this, 'advantage')">Advantage</button>
                    </div>
                    <input type="hidden" name="roll_modifier" id="roll-modifier-input" value="{{ roll_modifier|default:'normal' }}">
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; margin-bottom: 4px;">
                    <span class="text-muted" style="font-size: 12px;">Attack Bonus</span>
                    <span style="font-size: 16px; font-weight: 600; color: var(--accent);">+{{ attack_bonus|default:"0" }}</span>
                </div>

                <div class="flex-end gap-8" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-ghost" onclick="closeAttackModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Roll Attack</button>
                </div>
            </form>

        {% else %}
        <!-- Step 2: Attack result -->
            <div class="modal-header">
                Attack vs {{ target.character.name }} (AC {{ target.character.ac|default:"10" }})
            </div>

            <div class="{% if is_critical_hit %}critical-hit{% elif is_critical_miss %}critical-miss{% endif %}"
                 style="text-align: center; padding: 16px 0;">
                <div class="text-mono"
                     style="font-size: 48px; font-weight: 700; color: var(--accent); line-height: 1;">
                    {{ natural_roll }}
                </div>
                {% if roll_modifier != 'normal' %}
                    <div class="text-muted" style="font-size: 12px; margin-top: 4px;">
                        ({{ second_roll }}) —
                        {% if roll_modifier == 'advantage' %}Advantage{% else %}Disadvantage{% endif %}
                    </div>
                {% endif %}
                <div class="text-muted" style="font-size: 13px; margin-top: 8px;">
                    {{ natural_roll }} + {{ attack_bonus }} =
                    <strong style="color: var(--text);">{{ total_roll }}</strong>
                </div>
                <div style="margin-top: 12px;">
                    {% if is_critical_hit %}
                        <span class="badge badge-green" style="font-size: 14px; padding: 4px 12px;">CRITICAL HIT!</span>
                    {% elif is_critical_miss %}
                        <span class="badge badge-red" style="font-size: 14px; padding: 4px 12px;">CRITICAL MISS</span>
                    {% elif is_hit %}
                        <span class="badge badge-green" style="font-size: 14px; padding: 4px 12px;">HIT</span>
                    {% else %}
                        <span class="badge badge-red" style="font-size: 14px; padding: 4px 12px;">MISS</span>
                    {% endif %}
                </div>
                {% if weapon_name %}
                    <div class="text-muted" style="font-size: 12px; margin-top: 8px;">{{ weapon_name }}</div>
                {% endif %}
            </div>

            {% if is_hit %}
                <div style="border-top: 1px solid var(--border); padding-top: 12px; margin-top: 4px;">
                    {% if damage_rolled %}
                    <!-- Damage result -->
                        <div style="text-align: center; padding: 8px 0;">
                            <div class="text-muted" style="font-size: 12px;">{{ damage_formula }}</div>
                            {% if damage_dice %}
                                <div style="display: flex; justify-content: center; gap: 8px; margin: 8px 0;">
                                    {% for die in damage_dice %}
                                        <span class="damage-die"
                                              style="display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px; color: var(--red);">{{ die }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="text-mono"
                                 style="font-size: 32px; font-weight: 700; color: var(--red); line-height: 1.2; margin-top: 4px;">
                                {{ total_damage }}
                                <span style="font-size: 14px; font-weight: 400; color: var(--text-muted);">damage</span>
                            </div>
                        </div>
                        <form hx-post="{% url 'combat-apply-damage' game.id combat.id %}"
                              hx-target="#attack-modal"
                              hx-swap="outerHTML">
                            <input type="hidden" name="target_id" value="{{ target.id }}">
                            <input type="hidden" name="weapon_id" value="{{ weapon_id }}">
                            <input type="hidden" name="damage" value="{{ total_damage }}">
                            <div class="flex-end gap-8">
                                <button type="button" class="btn btn-ghost" onclick="closeAttackModal()">Cancel</button>
                                <button type="submit" class="btn btn-danger">Apply {{ total_damage }} Damage</button>
                            </div>
                        </form>
                    {% else %}
                    <!-- Roll damage -->
                        <form hx-post="{% url 'combat-damage-roll' game.id combat.id %}"
                              hx-target="#attack-modal"
                              hx-swap="outerHTML">
                            <input type="hidden" name="target_id" value="{{ target.id }}">
                            <input type="hidden" name="weapon_id" value="{{ weapon_id }}">
                            <input type="hidden" name="is_critical" value="{{ is_critical_hit|yesno:'true,false' }}">
                            <input type="hidden" name="natural_roll" value="{{ natural_roll }}">
                            <input type="hidden" name="total_roll" value="{{ total_roll }}">
                            <input type="hidden" name="attack_bonus" value="{{ attack_bonus }}">
                            <input type="hidden" name="total_damage" value="{{ total_damage }}">
                            <input type="hidden" name="damage_rolls" value="{{ damage_rolls|join:',' }}">
                            <input type="hidden" name="damage_formula" value="{{ damage_formula }}">
                            <div class="flex-end gap-8">
                                <button type="button" class="btn btn-ghost" onclick="closeAttackModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Roll Damage</button>
                            </div>
                        </form>
                    {% endif %}
                </div>
            {% else %}
            <!-- Miss -->
                <div class="flex-end"
                     style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-ghost" onclick="closeAttackModal()">Close</button>
                </div>
            {% endif %}
        {% endif %}

        {% if damage_applied %}
            <!-- Step 3: Damage applied -->
            <div style="text-align: center; padding: 8px 0;">
                <div style="font-size: 15px; font-weight: 600; color: var(--green); margin-bottom: 8px;">
                    Damage Applied
                </div>
                <div style="font-size: 13px; color: var(--text);">
                    {{ target.character.name }} took {{ damage_applied }} damage
                </div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                    HP: {{ target.character.hp }} / {{ target.character.max_hp }}
                </div>
            </div>
            {% if concentration_info %}
                <div style="padding: 12px; border: 1px solid rgba(155, 89, 182, 0.3); border-radius: var(--radius); margin-top: 12px; font-size: 13px;">
                    <div style="font-weight: 600; color: var(--text); margin-bottom: 4px;">
                        Concentration check required
                    </div>
                    <div class="text-muted">
                        {{ target.character.name }} must make a DC {{ concentration_info.dc }}
                        Constitution save to maintain {{ concentration_info.spell_name }}.
                    </div>
                </div>
                <div class="flex-end gap-8"
                     style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-ghost" onclick="closeAttackModal()">Later</button>
                    <button type="button"
                            class="btn btn-primary"
                            hx-get="{% url 'concentration-save-modal' game.id concentration_info.character_id %}?damage={{ concentration_info.damage }}"
                            hx-target="body"
                            hx-swap="beforeend"
                            onclick="closeAttackModal()">Roll Concentration Save</button>
                </div>
            {% else %}
                <div class="flex-end"
                     style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-ghost" onclick="closeAttackModal()">Close</button>
                </div>
            {% endif %}
        {% endif %}

    </div>
</div>

<script>
    function setRollModifier(button, value) {
        document.querySelectorAll('.toggle-group .btn').forEach(function(b) {
            b.classList.remove('active');
        });
        button.classList.add('active');
        document.getElementById('roll-modifier-input').value = value;
    }

    function closeAttackModal() {
        const modal = document.getElementById('attack-modal');
        if (modal) modal.classList.remove('active');
        htmx.trigger(document.body, 'attack-modal-closed');
    }
</script>
