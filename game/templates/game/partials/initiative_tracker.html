<div id="initiative-tracker">

    <div class="flex-between" style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="section-label">Initiative</span>
            <span class="text-muted" style="font-size: 12px;">Round {{ current_round }}</span>
        </div>
        {% if is_dm %}
            <div style="display: flex; gap: 8px;">
                <form action="{% url 'combat-advance-turn' game.id combat.id %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-ghost" style="font-size: 12px;">Next Turn</button>
                </form>
                <form action="{% url 'combat-end' game.id combat.id %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" style="font-size: 12px;">End Combat</button>
                </form>
            </div>
        {% endif %}
    </div>

    <div style="display: flex; flex-direction: column; gap: 4px;">
        {% for data in fighters %}
            <div class="{% if data.is_current %}current-turn{% endif %}" style="display: grid; grid-template-columns: 32px 1fr auto; gap: 10px; align-items: center; padding: 8px; border-radius: var(--radius); background: {% if data.is_current %}rgba(201, 162, 39, 0.06){% else %}transparent{% endif %};">

            <!-- Initiative value -->
                <span class="text-mono" style="font-size: 13px; text-align: center; color: {% if data.is_current %}var(--accent){% else %}var(--text-muted){% endif %};">
                    {{ data.initiative|default:"â€”" }}
                </span>

            <!-- Name + HP -->
                <div>
                    <div style="font-size: 13px; font-weight: {% if data.is_current %}600{% else %}400{% endif %}; color: {% if data.is_current %}var(--accent){% else %}var(--text){% endif %};">
                        {{ data.character.name }}
                        {% if data.is_owned_by_user %}<span class="text-muted" style="font-weight: 400;"> (you)</span>{% endif %}
                        {% if data.is_surprised %}<span class="badge badge-muted" style="margin-left: 4px;">surprised</span>{% endif %}
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 3px;">
                        <div class="hp-bar" style="flex: 1; max-width: 100px;">
                            <div class="hp-bar-fill {% if data.hp_percentage <= 25 %}critical{% elif data.hp_percentage <= 50 %}warning{% endif %}"
                                 style="width: {{ data.hp_percentage }}%;"></div>
                        </div>
                        <span style="font-size: 11px; color: var(--text-muted);">{{ data.hp }}/{{ data.max_hp }}</span>
                        {% if data.concentration %}
                            <span class="badge badge-muted" title="Concentrating on {{ data.concentration.spell.name }}">conc.</span>
                        {% endif %}
                        {% for char_condition in data.conditions %}
                            <span class="badge badge-red" style="font-size: 10px;" title="{{ char_condition.condition }}{% if char_condition.exhaustion_level %} L{{ char_condition.exhaustion_level }}{% endif %}">{{ char_condition.condition.name|lower }}</span>
                        {% endfor %}
                    </div>
                </div>

            <!-- Turn actions -->
                <div style="display: flex; gap: 4px;">
                    {% if data.is_player_turn %}
                        <button hx-post="{% url 'combat-ready' game.id combat.id %}"
                                hx-target="#initiative-tracker"
                                hx-swap="outerHTML"
                                class="btn btn-ghost" style="font-size: 11px; padding: 3px 8px;">Ready</button>
                        <button hx-post="{% url 'combat-delay' game.id combat.id %}"
                                hx-target="#initiative-tracker"
                                hx-swap="outerHTML"
                                class="btn btn-ghost" style="font-size: 11px; padding: 3px 8px;">Delay</button>
                    {% elif data.is_current %}
                        <span style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%; display: inline-block; margin: auto;"></span>
                    {% endif %}
                </div>

            </div>
        {% empty %}
            <p class="text-muted">No combatants in initiative order.</p>
        {% endfor %}
    </div>

</div>
