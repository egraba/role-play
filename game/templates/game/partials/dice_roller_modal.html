<div id="dice-roller-modal" class="rpg-modal {% if show_modal %}active{% endif %}">
    <div class="modal-content">
        <button class="modal-close" onclick="closeDiceRollerModal()" type="button">&times;</button>
        <div class="modal-header">Roll Dice</div>

        {% if error %}
            <div style="padding: 8px 12px; border: 1px solid rgba(192,57,43,0.4); border-radius: var(--radius); color: var(--red); font-size: 13px; margin-bottom: 12px;">
                {{ error }}
            </div>
        {% endif %}

        {% if not roll_result %}
            <form id="dice-roller-form"
                  hx-post="{% url 'dice-roll' game.id %}"
                  hx-target="#dice-roller-modal"
                  hx-swap="outerHTML">

                <div class="form-group">
                    <label>Die type</label>
                    <div class="toggle-group" style="flex-wrap: wrap;">
                        {% for die in dice_types %}
                            <button type="button"
                                    class="btn btn-ghost {% if die.value == 20 %}active{% endif %}"
                                    data-value="{{ die.value }}"
                                    onclick="selectDiceType(this, {{ die.value }})">{{ die.label }}</button>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="dice_type" id="dice-type-input" value="20">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>Number of Dice</label>
                        <input type="number" name="num_dice" id="num-dice-input" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Modifier</label>
                        <input type="number" name="modifier" id="modifier-input" value="0" min="-20" max="20">
                    </div>
                </div>

                <div class="form-group">
                    <label>Purpose (optional)</label>
                    <input type="text" name="roll_purpose" id="roll-purpose-input"
                           placeholder="e.g. Perception check" maxlength="50">
                </div>

                <div style="text-align: center; padding: 8px; font-size: 18px; font-weight: 600; color: var(--accent); font-family: ui-monospace, monospace;"
                     id="roll-preview-display">
                    1d20
                </div>

                <div class="flex-end gap-8"
                     style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-ghost" onclick="closeDiceRollerModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Roll</button>
                </div>
            </form>

        {% else %}
            <div style="text-align: center; padding: 8px 0;">
                {% if roll_purpose %}
                    <div class="text-muted" style="font-size: 12px; margin-bottom: 12px;">{{ roll_purpose }}</div>
                {% endif %}

                {% if individual_rolls %}
                    <div style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                        {% for roll in individual_rolls %}
                            <span class="die-result {% if roll == dice_type %}max-roll{% elif roll == 1 %}min-roll{% endif %}"
                                  style="display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px; color: {% if roll == dice_type %}var(--green){% elif roll == 1 %}var(--red){% else %}var(--text){% endif %};">{{ roll }}</span>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="text-mono" style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">
                    {{ dice_notation }}{% if modifier > 0 %} +{{ modifier }}{% elif modifier < 0 %} {{ modifier }}{% endif %}
                    =
                    ({% for roll in individual_rolls %}{{ roll }}{% if not forloop.last %} + {% endif %}{% endfor %}){% if modifier != 0 %} {% if modifier > 0 %}+{% endif %}{{ modifier }}{% endif %}
                </div>

                <div class="text-mono total-result"
                     style="font-size: 48px; font-weight: 700; color: var(--accent); line-height: 1.1;">
                    {{ total }}
                </div>
            </div>

            <div class="flex-end gap-8"
                 style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <button type="button" class="btn btn-ghost" onclick="closeDiceRollerModal()">Close</button>
                <button type="button" class="btn btn-ghost" onclick="resetDiceRoller()">Roll Again</button>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function selectDiceType(button, value) {
        document.querySelectorAll('#dice-roller-modal .toggle-group .btn').forEach(function(b) {
            b.classList.remove('active');
        });
        button.classList.add('active');
        document.getElementById('dice-type-input').value = value;
        updateDicePreview();
    }

    function updateDicePreview() {
        const n = document.getElementById('num-dice-input')?.value || 1;
        const t = document.getElementById('dice-type-input')?.value || 20;
        const m = parseInt(document.getElementById('modifier-input')?.value || 0);
        const el = document.getElementById('roll-preview-display');
        if (!el) return;
        let text = n + 'd' + t;
        if (m > 0) text += ' +' + m;
        else if (m < 0) text += ' ' + m;
        el.textContent = text;
    }

    function closeDiceRollerModal() {
        const modal = document.getElementById('dice-roller-modal');
        if (modal) modal.classList.remove('active');
        htmx.trigger(document.body, 'dice-roller-closed');
    }

    function resetDiceRoller() {
        htmx.ajax('GET', '{% url "dice-roller-modal" game.id %}', {
            target: '#dice-roller-modal', swap: 'outerHTML'
        });
    }

    document.addEventListener('input', function(e) {
        if (['num-dice-input', 'modifier-input'].includes(e.target.id)) updateDicePreview();
    });
</script>
