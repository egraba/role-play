{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

    <div class="rpgui-container framed">
        <h1 id="title" class="title">{{ game }}</h1>
        <div class="rpgui-center">
            <a href={% url 'game-list' %}>- Return to games list -</a>
        </div>

        <hr class="golden"/>
        <br />

        <h2>Quest</h2>
        <div id="quest" class="rpgui-container framed-golden-2"><p >{{ quest|linebreaks }}</p></div>

        <div id="game">
            <div id="events" class="rpgui-container framed-grey">
                <h3>Game events</h3>
                <div id="event-list">
                    {% for event in event_list reversed %}
                        <p>{{ event.date|naturaltime }}, {{ event.message }} {{ event.instruction.content }} {{ event.choice.selection }} {{ event.dicelaunch.score }}</p>
                    {% empty %}
                        <p>The campaign did not start yet...</p>
                    {% endfor %}
                </div>
            </div>

            {% if game.is_ongoing %}
                <div id="messaging">
                    <p>
                        <label>Message:</label>
                        <input id="message-input" type="text">
                    </p>
                    <div class="rpgui-center">
                        {% if game.master.user == user %}
                            <button id="master-message-submit" class="rpgui-button" type="submit">
                                <p>Send</p>
                            </button>
                        {% else %}
                            <button id="player-message-submit" class="rpgui-button" type="submit">
                                <p>Send</p>
                            </button>
                            <button id="dice-launch-submit" class="rpgui-button" type="submit">
                                <p>Launch dice</p>
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <div id="panel">
                <div id="characters" class="rpgui-container framed-grey">
                    <h3>Characters</h3>
                    {% for character in character_list %}
                        {% with character_user=character.user %}
                            <p>
                                <a href={{ character.get_absolute_url }}>{{ character }}</a>
                                {% if character_user == user %}
                                    (played by you)
                                {% else %}
                                    (played by {{ character_user }})
                                {% endif %}
                            </p>
                        {% endwith %}
                    {% empty %}
                        <div class="rpgui-center">
                            <p>There is no character for this game...</p>
                        </div>
                    {% endfor %}
                    {% if game.master.user == user %}
                        <div class="rpgui-center">
                            <a href={% url 'game-invite-character' game.id %}>
                                <button class="rpgui-button"><p>Invite a character</p></button>
                            </a>
                        </div>
                    {% endif %}
                </div>

                {% if game.master.user == user %}
                    <div id="master" class="rpgui-container framed-grey">
                        <h3>Master's panel</h3>
                        <div class="rpgui-center">
                            {% if game.is_under_preparation %}
                                <p>
                                    <a href={% url 'game-start' game.id %}>
                                        <button class="rpgui-button"><p>Start the game</p></button>
                                    </a>
                                </p>
                            {% elif game.is_ongoing %}
                                <p>
                                    <a href={% url 'quest-create' game.id %}>
                                        <button class="rpgui-button"><p>Update the quest</p></button>
                                    </a>
                                </p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>

        </div>

        <div class="rpgui-center inline">
            <img class="rpgui-icon" style="transform: scaleX(-1)" src={% static 'images/mini-skull.png' %}>
            <a href="#title">- Back to top -</a>
            <img class="rpgui-icon" src={% static 'images/mini-skull.png' %}>
        </div>
    </div>

    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script>
        if (window.location.protocol === 'https:') {
            wsProtocol = 'wss://'
        } else {
            wsProtocol = 'ws://'
        }
        var url = wsProtocol + window.location.host + '/events/' + {{ game.id }} + '/';
        const eventsSocket = new WebSocket(url);
        const eventList = document.getElementById('event-list');
        const input = document.getElementById('message-input');
        const masterSendButton = document.getElementById('master-message-submit');
        const playerSendButton = document.getElementById('player-message-submit');
        const playerDiceLaunchButton = document.getElementById('dice-launch-submit');

        eventsSocket.onmessage = function(event) {
            message = JSON.parse(event.data)
            eventList.innerHTML += '<p>' + moment(message["date"]).fromNow() + ', ' + message["message"] + message["content"] + '</p>'
            lines = eventList.innerHTML.split('</p>');
            if (lines.length > 10) {
                lines.splice(0, 1);
                eventList.innerHTML = lines.join('\n');
            }
            if (message["type"] === "master.quest") {
                $("#quest").load(" #quest > *");
            }
        };

        eventsSocket.onclose = function(event) {
            console.error('Events socket closed unexpectedly...');
        };

        if (masterSendButton !== null) {
            masterSendButton.addEventListener('click', function(event) {
                const message = input.value;
                if (message) {
                    eventsSocket.send(JSON.stringify({
                        'type': 'master.instruction',
                        'content': message,
                    }));
                    input.value = '';
                    input.focus();
                }
            });

            input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    masterSendButton.click();
                }
            });
        }

        if (playerSendButton !== null) {
            playerSendButton.addEventListener('click', function(event) {
                const message = input.value;
                if (message) {
                    eventsSocket.send(JSON.stringify({
                        'type': 'player.choice',
                        'content': message
                    }));
                    input.value = '';
                    input.focus();
                }
            });

            input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    playerSendButton.click();
                }
            });
        }

        if (playerDiceLaunchButton !== null) {
            playerDiceLaunchButton.addEventListener('click', function(event) {
                eventsSocket.send(JSON.stringify({
                    'type': 'player.dice.launch',
                }));
            });
        }

        input.focus();

    </script>

{% endblock %}
