{% extends 'base.html' %}
{% load static %}

{% block content %}
    <script src={% static 'django_eventstream/eventsource.min.js' %}></script>
    <script src={% static 'django_eventstream/reconnecting-eventsource.js' %}></script>

    <script>
        var es = new ReconnectingEventSource('/events/');

        es.addEventListener('message', function (e) {
            const obj = JSON.parse(e.data)
            if (obj.game === {{game.id}}) {
                if (obj.refresh === "tale") {
                    $("#tale").load(window.location.href + " #tale");
                } else if (obj.refresh === "instruction") {
                    $("#instruction").load(window.location.href + " #instruction");
                } else if (obj.refresh === "event") {
                    $("#events").load(window.location.href + " #events");
                    $("#actions").load(window.location.href + " #actions");
                    $("#characters").load(window.location.href + " #characters");
                }
            }
        }, false);
    </script>

    <div class="rpgui-container framed">
        <h1 id="title" class="title">{{ game }}</h1>
        <div class="rpgui-center">
            <a href={% url 'game-list' %}>- Return to games list -</a>
        </div>

        <hr class="golden"/>
        <br />

        <h2>Quest</h2>
        <div id="tale" class="rpgui-container framed-golden-2"><p >{{ tale|linebreaks }}</p></div>

        <div id="characters">
            <h2>Characters</h2>
            {% if character_list %}
                <table>
                    <tr>
                        <th><p>Name</p></th>
                        <th><p>User</p></th>
                        <th><p>Race</p></th>
                        <th><p>XP</p></th>
                        <th><p>HP</p></th>
                        <th><p>Pending action</p></th>
                    </tr>
                </table>
            {% endif %}
            {% for character in character_list %}
                <table class="character rpgui-container framed-grey">
                    <tr>
                        <td><a href={{ character.get_absolute_url }}>{{ character.name }}</a></td>
                        <td><p>
                            {% with character_user=character.user %}
                                {% if user == character_user %}
                                    (you)
                                {% else %}
                                    {{ character_user }}
                                {% endif %}
                            {% endwith %}
                        </p></td>
                        <td><p>{{ character.get_race_display }}</p></td>
                        <td><p>{{ character.xp }}</p></td>
                        <td><p>{{ character.hp }} / {{ character.max_hp }}</p></td>
                        <td><p>
                            {% if character.pendingaction %}
                                (pending {{ character.pendingaction.get_action_type_display }})
                            {% endif %}
                        </p></td>
                    </tr>
                    {% if game.master.user == user and game.is_ongoing %}
                        <tr><td colspan="6">
                            <div class ="rpgui-center inline">
                                {% if not character.pendingaction %}
                                    <a href={% url 'pendingaction-create' game.id character.id %}>
                                        <button class="rpgui-button"><p>Ask for action</p></button>
                                    </a>
                                {% else %}
                                    <button disabled class="rpgui-button"><p>Ask for action</p></button>
                                {% endif %}
                                <a href={% url 'xpincrease-create' game.id character.id %}>
                                    <button class="rpgui-button"><p>Increase XP</p></button>
                                </a>
                                <a href={% url 'damage-create' game.id character.id %}>
                                    <button class="rpgui-button"><p>Damage</p></button>
                                </a>
                                <a href={% url 'healing-create' game.id character.id %}>
                                    <button class="rpgui-button"><p>Heal</p></button>
                                </a>
                            </div>
                        </td></tr>
                    {% endif %}
                </table>
            {% empty %}
                <div class="rpgui-center">
                    <p>There is no character for this game...</p>
                </div>
            {% endfor %}
        </div>

        {% if user.is_authenticated and user == game.master.user %}
            <div class="rpgui-center inline">
                {% if game.is_under_preparation %}
                    <a href={% url 'game-invite-character' game.id %}>
                        <button class="rpgui-button"><p>Invite a character</p></button>
                    </a>
                    <a href={% url 'game-start' game.id %}>
                        <button class="rpgui-button"><p>Start the game</p></button>
                    </a>
                    <button disabled class="rpgui-button"><p>End the game</p></button>
                {% elif game.is_ongoing %}
                    <button disabled class="rpgui-button"><p>Invite a character</p></button>
                    <button disabled class="rpgui-button"><p>Start the game</p></button>
                    <a href={% url 'game-end' game.id %}>
                        <button class="rpgui-button"><p>End the game</p></button>
                    </a>
                {% else %}
                    <p>The game is finished.</p>
                {% endif%}
            </div>
        {% endif %}

        {% if game.is_ongoing %}
            <div id="actions" class="rpgui-center">
                {% if game.master.user == user %}
                    <a href={% url 'tale-create' game.id %}>
                        <button class="rpgui-button"><p>Continue the story</p></button>
                    </a>
                    <a href={% url 'instruction-create' game.id %}>
                        <button class="rpgui-button"><p>Give an instruction</p></button>
                    </a>
                {% endif %}
                {% if player.character.pendingaction %}
                    {% if player.character.pendingaction.get_action_type_display == "Launch dice" %}
                        <a class="character-action" href={% url 'dicelaunch-create' game.id player.character.id %}>
                            <button class="rpgui-button">
                                <p>{{ player.character.pendingaction.get_action_type_display }}</p>
                            </button>
                        </a>
                    {% endif %}
                    {% if player.character.pendingaction.get_action_type_display == "Make choice" %}
                        <a class="character-action" href={% url 'choice-create' game.id player.character.id %}>
                            <button class="rpgui-button">
                                <p>{{ player.character.pendingaction.get_action_type_display }}</p>
                            </button>
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}

        <hr />

        <div id="events">
            <h2>Game events</h2>
            <div class="rpgui-container framed-grey">
                {% for event in event_list %}
                    <p>{{ event.date|timesince }} ago, {{ event.message }}</p>
                {% empty %}
                    <p>The story did not start yet...</p>
                {% endfor %}
            </div>
        </div>
        {% include 'pagination.html' %}


        <div class="rpgui-center inline">
            <img class="rpgui-icon" style="transform: scaleX(-1)" src={% static 'images/mini-skull.png' %}>
            <a href="#title">- Back to top -</a>
            <img class="rpgui-icon" src={% static 'images/mini-skull.png' %}>
        </div>
    </div>
{% endblock %}
