{% extends 'base.html' %}
{% load static %}

{% block content %}
    <script>
        var es = new ReconnectingEventSource('/events/');

        es.addEventListener('message', function (e) {
            const obj = JSON.parse(e.data)
            if (obj.game === {{game.id}}) {
                if (obj.refresh === "tale") {
                    $("#tale").load(window.location.href + " #tale");
                } else if (obj.refresh === "event") {
                    $("#events").load(window.location.href + " #events");
                }
            }
        }, false);
    </script>

    <div class="rpgui-container framed">
        <h1 id="title" class="title">{{ game }}</h1>
        <div class="rpgui-center">
            <a href={% url 'index' %}>- Return to main menu -</a>
        </div>

        <hr class="golden"/>

        <img class="rpgui-icon wizard" src={% static 'images/wizard.png' %}>
        <div id="tale"><p >{{ tale }}</p></div>
        <div class="rpgui-center">
            <a href={% url 'room' game.room.id %}>- Join the chat -</a>
        </div>

        <hr/>

        {% for character in character_list %}
            <div class="character rpgui-container framed-grey">
                <p>
                    <a href={{ character.get_absolute_url }} style="width:100em">
                        {{ character.name }}
                    </a>
                    Race: {{ character.get_race_display }},
                    XP: {{ character.xp }},
                    HP: {{ character.hp }} / {{ character.max_hp }}
                    {% if character.pendingaction %}
                        (pending {{ character.pendingaction.get_action_type_display }})
                    {% endif %}
                    {% if player %}
                        {% if user.id == character.user.id %}(you){% endif %}
                    {% endif %}

                    {% if user.is_authenticated and game.get_status_display == "Ongoing" %}
                        <div class ="rpgui-center inline">
                            {% if perms.game.add_pendingaction %}
                                {% if not character.pendingaction %}
                                    <a href={% url 'pendingaction-create' game.id character.id %}>
                                        <button class="rpgui-button"><p>Ask for action</p></button>
                                    </a>
                                {% else %}
                                    <button disabled class="rpgui-button"><p>Ask for action</p></button>
                                {% endif %}
                            {% endif %}
                            {% if perms.game.add_xpincrease %}
                                <a href={% url 'xpincrease-create' game.id character.id %}>
                                    <button class="rpgui-button"><p>Increase XP</p></button>
                                </a>
                            {% endif %}
                            {% if perms.game.add_damage %}
                                <a href={% url 'damage-create' game.id character.id %}>
                                    <button class="rpgui-button"><p>Damage</p></button>
                                </a>
                            {% endif %}
                            {% if perms.game.add_healing %}
                                <a href={% url 'healing-create' game.id character.id %}>
                                    <button class="rpgui-button"><p>Heal</p></button>
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </p>
            </div>
        {% empty %}
            <p>There is no character for this game...</p>
        {% endfor %}
        {% if user.is_authenticated %}
            <div class="rpgui-center inline">
                {% if perms.game.change_character %}
                    {% if game.get_status_display == "Under preparation" %}
                        <a href={% url 'game-invite-character' game.id %}>
                            <button class="rpgui-button"><p>Invite a character</p></button>
                        </a>
                    {% else %}
                        <button disabled class="rpgui-button"><p>Invite a character</p></button>
                    {% endif %}
                {% endif %}
                {% if perms.game.change_game %}
                    {% if game.get_status_display == "Under preparation" %}
                        <a href={% url 'game-start' game.id %}>
                            <button class="rpgui-button"><p>Start the game</p></button>
                        </a>
                        <button disabled class="rpgui-button"><p>End the game</p></button>
                    {% elif game.get_status_display == "Ongoing" %}
                        <button disabled class="rpgui-button"><p>Start the game</p></button>
                        <a href={% url 'game-end' game.id %}>
                            <button class="rpgui-button"><p>End the game</p></button>
                        </a>
                    {% else %}
                        <button disabled class="rpgui-button"><p>Start the game</p></button>
                        <button disabled class="rpgui-button"><p>End the game</p></button>
                    {% endif%}

                {% endif %}
            </div>
        {% endif %}

        <hr />

        <div id="events" class="rpgui-container framed-grey">
            {% for event in event_list %}
                <p>{{ event.date }}, {{ event.message }}</p>
            {% empty %}
                <p>The story did not start yet...</p>
            {% endfor %}
        </div>
        {% include 'pagination.html' %}

        {% if user.is_authenticated and game.get_status_display == "Ongoing" %}
            <div class="rpgui-center">
                {% if perms.game.add_tale %}
                    <a href={% url 'tale-create' game.id %}>
                        <button class="rpgui-button"><p>Continue the story</p></button>
                    </a>
                {% endif %}
                {% if player.pendingaction %}
                    {% if perms.game.add_dicelaunch and player.pendingaction.get_action_type_display == "Launch dice" %}
                        <a class="character-action" href={% url 'dicelaunch-create' game.id player.id %}>
                            <button class="rpgui-button">
                                <p>{{ player.pendingaction.get_action_type_display }}</p>
                            </button>
                        </a>
                    {% endif %}
                    {% if perms.game.add_choice and player.pendingaction.get_action_type_display == "Make choice" %}
                        <a class="character-action" href={% url 'choice-create' game.id player.id %}>
                            <button class="rpgui-button">
                                <p>{{ player.pendingaction.get_action_type_display }}</p>
                            </button>
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}

        <div class="rpgui-center inline">
            <img class="rpgui-icon" style="transform: scaleX(-1)" src={% static 'images/mini-skull.png' %}>
            <a href="#title">- Back to top -</a>
            <img class="rpgui-icon" src={% static 'images/mini-skull.png' %}>
        </div>
    </div>
{% endblock %}
