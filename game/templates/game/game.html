{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

    <div class="rpg-container">
        <div class="rpg-panel">
            <h1 id="title" class="panel-title" style="font-size: 2.5rem;"><img src="/static/images/icons/actions/attack.svg" alt="" class="rpg-icon rpg-icon-xl rpg-icon-primary"> {{ game }}</h1>
            <div class="text-center mb-2">
                <a href="{% url 'game-list' %}" style="color: var(--color-primary); text-decoration: underline;">Return to games list</a>
            </div>

            <div class="rpg-section">
                <h2 class="panel-title" style="font-size: 1.5rem;"><img src="/static/images/icons/actions/search.svg" alt="" class="rpg-icon rpg-icon-md rpg-icon-warning"> Quest</h2>
                <div id="quest" class="game-message info" style="white-space: pre-line;">{{ quest.environment }}</div>
            </div>

            <div id="game">
                <div class="rpg-section">
                    <div id="events" class="rpg-panel" style="background: rgba(0, 0, 0, 0.3);">
                        <h3 class="panel-title" style="font-size: 1.2rem;"><img src="/static/images/icons/actions/roll.svg" alt="" class="rpg-icon rpg-icon-md rpg-icon-warning"> Game Events</h3>
                        <div id="event-list" style="max-height: 300px; overflow-y: auto;">
                            {% for event in event_list reversed %}
                                <p style="margin: 5px 0; color: var(--color-text);">[{{ event.date|date:"G:i" }}] {{ event.get_message }}</p>
                            {% empty %}
                                <p class="text-muted">The campaign did not start yet...</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {% if flow.is_ongoing %}
                    <div id="messaging" class="rpg-section">
                        <div class="rpg-form-group">
                            <label for="message-input">Message:</label>
                            <input id="message-input" type="text" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 2px solid var(--color-border); color: var(--color-text); font-family: var(--font-text); border-radius: 4px;">
                        </div>
                        <div id="player-actions" class="action-buttons">
                            <button id="message-submit" class="rpg-btn btn-primary" type="submit">Send</button>
                            {% if player %}
                                {% if ability_check_request %}
                                    <button id="ability-check-submit" class="rpg-btn btn-skill" type="submit">Perform ability check</button>
                                {% endif %}
                                {% if saving_throw_request %}
                                    <button id="saving-throw-submit" class="rpg-btn btn-defend" type="submit">Perform saving throw</button>
                                {% endif %}
                                {% if combat_initiative_request %}
                                    <button id="dexterity-check-submit" class="rpg-btn btn-attack" type="submit">Perform dexterity check</button>
                                {% endif %}
                            {% endif%}
                        </div>
                    </div>
                {% endif %}

                <div id="panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div class="rpg-section">
                        <div id="characters" class="rpg-panel" style="background: rgba(0, 0, 0, 0.3);">
                            <h3 class="panel-title" style="font-size: 1.2rem;"><img src="/static/images/icons/actions/help.svg" alt="" class="rpg-icon rpg-icon-md rpg-icon-primary"> Characters</h3>
                            {% for character in character_list %}
                                {% with character_user=character.user %}
                                    <p style="margin: 8px 0;">
                                        <a href="{{ character.get_absolute_url }}" style="color: var(--color-primary); text-decoration: underline;">{{ character }}</a>
                                        {% if character_user == user %}
                                            <span class="text-muted">(played by you)</span>
                                        {% else %}
                                            <span class="text-muted">(played by {{ character_user }})</span>
                                        {% endif %}
                                    </p>
                                {% endwith %}
                            {% empty %}
                                <p class="text-center text-muted">There are no characters for this game...</p>
                            {% endfor %}
                            {% if game.master.user == user %}
                                <div class="text-center mt-2">
                                    <a href="{% url 'game-invite-user' game.id %}" class="rpg-btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Invite a user</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if game.master.user == user %}
                        <div class="rpg-section">
                            <div id="master" class="rpg-panel" style="background: rgba(139, 69, 19, 0.2);">
                                <h3 class="panel-title" style="font-size: 1.2rem;"><img src="/static/images/icons/actions/persuade.svg" alt="" class="rpg-icon rpg-icon-md rpg-icon-warning"> Master's Panel</h3>
                                <div class="action-buttons" style="flex-direction: column;">
                                    {% if flow.is_under_preparation %}
                                        <a href="{% url 'game-start' game.id %}" class="rpg-btn btn-primary">Start the game</a>
                                    {% elif flow.is_ongoing %}
                                        <a href="{% url 'quest-create' game.id %}" class="rpg-btn btn-primary">Update the quest</a>
                                        <a href="{% url 'ability-check-request-create' game.id %}" class="rpg-btn btn-skill">Ask for ability check</a>
                                        <a href="{% url 'combat-create' game.id %}" class="rpg-btn btn-attack">Initiate combat</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

            </div>

            <div class="text-center mt-2">
                <img src="/static/images/icons/conditions/unconscious.svg" alt="" class="rpg-icon rpg-icon-sm rpg-icon-danger" style="transform: scaleX(-1);">
                <a href="#title" style="color: var(--color-primary); text-decoration: underline; margin: 0 10px;">Back to top</a>
                <img src="/static/images/icons/conditions/unconscious.svg" alt="" class="rpg-icon rpg-icon-sm rpg-icon-danger">
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection configuration
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const url = wsProtocol + window.location.host + '/events/' + {{ game.id }} + '/';

        // DOM elements
        const eventList = document.getElementById('event-list');
        const input = document.getElementById('message-input');
        const sendButton = document.getElementById('message-submit');
        const abilityCheckButton = document.getElementById('ability-check-submit');
        const dexterityCheckButton = document.getElementById('dexterity-check-submit');
        const savingThrowButton = document.getElementById('saving-throw-submit');

        // Event types
        const MESSAGE = "message";
        const QUEST_UPDATE = "quest.update";
        const ABILITY_CHECK_RESPONSE = "ability.check.response";
        const SAVING_THROW_RESPONSE = "saving.throw.response";
        const COMBAT_INITIATIVE_RESPONSE = "combat.initiative.response";

        // WebSocket reconnection state
        let eventsSocket = null;
        let reconnectAttempts = 0;
        const baseReconnectDelay = 1000; // 1 second
        const maxReconnectDelay = 30000; // 30 seconds
        let reconnectTimeout = null;

        // Create connection status indicator
        function createConnectionStatus() {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'connection-status';
            statusDiv.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 10px 15px; border-radius: 5px; font-size: 0.9rem; z-index: 1000; display: none; cursor: pointer;';
            statusDiv.title = 'Click to retry connection';
            statusDiv.addEventListener('click', function() {
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                }
                reconnectAttempts = 0;
                showConnectionStatus('üîÑ Connecting...', true);
                connectWebSocket();
            });
            document.body.appendChild(statusDiv);
            return statusDiv;
        }
        const connectionStatus = createConnectionStatus();

        function showConnectionStatus(message, isError) {
            connectionStatus.textContent = message;
            connectionStatus.style.display = 'block';
            connectionStatus.style.background = isError ? 'rgba(139, 0, 0, 0.9)' : 'rgba(0, 100, 0, 0.9)';
            connectionStatus.style.color = 'white';
            connectionStatus.style.border = isError ? '2px solid #ff6666' : '2px solid #66ff66';
        }

        function hideConnectionStatus() {
            connectionStatus.style.display = 'none';
        }

        function connectWebSocket() {
            if (eventsSocket && eventsSocket.readyState === WebSocket.OPEN) {
                return; // Already connected
            }

            eventsSocket = new WebSocket(url);

            eventsSocket.onopen = function(event) {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                hideConnectionStatus();
                // Enable input if it was disabled
                if (input) input.disabled = false;
                if (sendButton) sendButton.disabled = false;
            };

            eventsSocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                const date = new Date(message["date"]);
                eventList.innerHTML += '<p>[' + date.getUTCHours() + ':' + date.getUTCMinutes() + '] ' + message["message"] + '</p>';
                const lines = eventList.innerHTML.split('</p>');
                if (lines.length > 10) {
                    lines.splice(0, 1);
                    eventList.innerHTML = lines.join('\n');
                }
                if (message["type"] === QUEST_UPDATE) {
                    $("#quest").load(" #quest > *");
                } else if (message["type"] === MESSAGE) {
                    // Do nothing.
                } else {
                    // The full page has to be reloaded, otherwise clicking on the button
                    // triggers no action.
                    location.reload();
                }
            };

            eventsSocket.onclose = function(event) {
                console.warn('WebSocket closed:', event.code, event.reason);
                scheduleReconnect();
            };

            eventsSocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                // onclose will be called after onerror
            };
        }

        function scheduleReconnect() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }

            // Disable input while disconnected
            if (input) input.disabled = true;
            if (sendButton) sendButton.disabled = true;

            // Calculate delay with exponential backoff and jitter (caps at maxReconnectDelay)
            const delay = Math.min(
                baseReconnectDelay * Math.pow(2, reconnectAttempts) + Math.random() * 1000,
                maxReconnectDelay
            );
            reconnectAttempts++;

            // Show status - after many attempts, indicate click to retry immediately
            if (reconnectAttempts > 10) {
                showConnectionStatus(`üîÑ Reconnecting in ${Math.round(delay/1000)}s... (click to retry now)`, true);
            } else {
                showConnectionStatus(`üîÑ Reconnecting... (attempt ${reconnectAttempts})`, true);
            }

            reconnectTimeout = setTimeout(function() {
                console.log(`Reconnecting... attempt ${reconnectAttempts}`);
                connectWebSocket();
            }, delay);
        }

        function sendMessage(data) {
            if (eventsSocket && eventsSocket.readyState === WebSocket.OPEN) {
                eventsSocket.send(JSON.stringify(data));
                return true;
            } else {
                showConnectionStatus('‚ö†Ô∏è Not connected. Reconnecting...', true);
                scheduleReconnect();
                return false;
            }
        }

        // Initialize WebSocket connection
        connectWebSocket();

        // Event listeners
        if (sendButton !== null) {
            sendButton.addEventListener('click', function(event) {
                const userInput = input.value;
                if (userInput) {
                    if (sendMessage({
                        'type': MESSAGE,
                        'date': Date.now(),
                        'username': '{{ user.username }}',
                        'message': userInput,
                    })) {
                        input.value = '';
                        input.focus();
                    }
                }
            });

            input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendButton.click();
                }
            });
        }

        if (abilityCheckButton !== null) {
            abilityCheckButton.addEventListener('click', function(event) {
                sendMessage({
                    'type': ABILITY_CHECK_RESPONSE,
                    'date': Date.now(),
                    'username': '{{ user.username }}',
                });
            });
        }

        if (savingThrowButton !== null) {
            savingThrowButton.addEventListener('click', function(event) {
                sendMessage({
                    'type': SAVING_THROW_RESPONSE,
                    'date': Date.now(),
                    'username': '{{ user.username }}',
                });
            });
        }

        if (dexterityCheckButton !== null) {
            dexterityCheckButton.addEventListener('click', function(event) {
                sendMessage({
                    'type': COMBAT_INITIATIVE_RESPONSE,
                    'date': Date.now(),
                    'username': '{{ user.username }}',
                });
            });
        }

        if (input) input.focus();

    </script>

{% endblock %}
