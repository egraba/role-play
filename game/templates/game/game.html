{% extends 'base.html' %}
{% load static %}

{% block content %}
    <script src={% static 'django_eventstream/eventsource.min.js' %}></script>
    <script src={% static 'django_eventstream/reconnecting-eventsource.js' %}></script>

    <script>
        var es = new ReconnectingEventSource('/events/');

        es.addEventListener('message', function (e) {
            const obj = JSON.parse(e.data)
            if (obj.game === {{game.id}}) {
                if (obj.refresh === "tale") {
                    $("#tale").load(window.location.href + " #tale");
                } else if (obj.refresh === "instruction") {
                    $("#instruction").load(window.location.href + " #instruction");
                } else if (obj.refresh === "event") {
                    $("#events").load(window.location.href + " #events");
                    $("#actions").load(window.location.href + " #actions");
                    $("#characters").load(window.location.href + " #characters");
                }
            }
        }, false);
    </script>

    <div class="rpgui-container framed">
        <h1 id="title" class="title">{{ game }}</h1>
        <div class="rpgui-center">
            <a href={% url 'game-list' %}>- Return to games list -</a>
        </div>

        <hr class="golden"/>
        <br />

        <h2>Quest</h2>
        <div id="tale" class="rpgui-container framed-golden-2"><p >{{ tale|linebreaks }}</p></div>

        <div id="events" class="rpgui-container framed-grey">
            <h3>Game events</h3>
            {% for event in event_list %}
                <p>{{ event.date|timesince }} ago, {{ event.message }}</p>
            {% empty %}
                <p>The story did not start yet...</p>
            {% endfor %}
        </div>

        <div id="characters" class="rpgui-container framed-grey">
            <h3>Characters</h3>
            {% for character in character_list %}
                {% with character_user=character.user %}
                    <p>
                        <a href={{ character.get_absolute_url }}>{{ character }}</a>
                        {% if character_user == user %}
                            (played by you)
                        {% else %}
                            (played by {{ character_user }})
                        {% endif %}
                    </p>
                {% endwith %}
            {% empty %}
                <div class="rpgui-center">
                    <p>There is no character for this game...</p>
                </div>
            {% endfor %}
            <div class="rpgui-center">
                <a href={% url 'game-invite-character' game.id %}>
                    <button class="rpgui-button"><p>Invite a character</p></button>
                </a>
            </div>
        </div>

        {% if game.master.user == user %}
            <div id="master" class="rpgui-container framed-grey">
                <h3>Master's panel</h3>
                <div class="rpgui-center">
                    {% if game.is_under_preparation %}
                        <p>
                            <a href={% url 'game-start' game.id %}>
                                <button class="rpgui-button"><p>Start the game</p></button>
                            </a>
                        </p>
                    {% elif game.is_ongoing %}
                        <p>
                            <a href={% url 'tale-create' game.id %}>
                                <button class="rpgui-button"><p>Continue the story</p></button>
                            </a>
                        </p>
                        <p>
                            <a href={% url 'instruction-create' game.id %}>
                                <button class="rpgui-button"><p>Give an instruction</p></button>
                            </a>
                        </p>
                    {% endif %}
                </div>
            </div>
        {% endif %}


        <div class="rpgui-center inline">
            <img class="rpgui-icon" style="transform: scaleX(-1)" src={% static 'images/mini-skull.png' %}>
            <a href="#title">- Back to top -</a>
            <img class="rpgui-icon" src={% static 'images/mini-skull.png' %}>
        </div>
    </div>
{% endblock %}
