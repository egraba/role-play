{% extends 'base.html' %}
{% load static %}

{% block content %}
    <script>
        const url = 'ws://' + window.location.host + '/ws/chat/' + {{ game.id }} + '/';
        const chatSocket = new WebSocket(url);

        chatSocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const chat = document.getElementById('chat');
            chat.innerHTML += data.user
            + ' (' + new Date(data.datetime).toLocaleString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
            }) + '): '
            + data.message + '\n';
            chat.scrollTop = chat.scrollHeight;
        };

        chatSocket.onclose = function(event) {
            console.error('Chat socket closed unexpectedly');
        };

        const chat = document.getElementById('chat');
        const input = document.getElementById('chat-message-input');
        const submitButton = document.getElementById('chat-message-submit');

        {% for message in message_list %}
            chat.innerHTML += '{{ message.user }} ('
            + new Date('{{ message.date|date:"M d, Y" }}').toLocaleString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
            }) + '): '
            chat.innerHTML += '{{ message.content }}' + '\n';
        {% empty %}
            chat.innerHTML = '';
        {% endfor %}

        submitButton.addEventListener('click', function(event) {
            const message = input.value;
            if (message) {
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                input.value = '';
                input.focus();
            }
        });

        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitButton.click();
            }
        });
        input.focus();
    </script>

    <div class="rpgui-container framed">
        <h1 id="title" class="title">{{ game }}</h1>
        <div class="rpgui-center">
            <a href={% url 'game-list' %}>- Return to games list -</a>
        </div>

        <hr class="golden"/>
        <br />

        <h2>Quest</h2>
        <div id="quest" class="rpgui-container framed-golden-2"><p >{{ tale|linebreaks }}</p></div>

        <div id="game">
            <div id="events" class="rpgui-container framed-grey">
                <h3>Game events</h3>
                {% for event in event_list %}
                    <p>{{ event.date|timesince }} ago, {{ event.message }}</p>
                {% empty %}
                    <p>The story did not start yet...</p>
                {% endfor %}
            </div>

            <div id="messaging">
                <p>
                    <label>Message:</label>
                    <input id="message-input" type="text">
                </p>
                <div class="rpgui-center">
                    <button id="message-submit" class="rpgui-button" type="submit"><p>Send</p></button>
                </div>
            </div>

            <div id="characters" class="rpgui-container framed-grey">
                <h3>Characters</h3>
                {% for character in character_list %}
                    {% with character_user=character.user %}
                        <p>
                            <a href={{ character.get_absolute_url }}>{{ character }}</a>
                            {% if character_user == user %}
                                (played by you)
                            {% else %}
                                (played by {{ character_user }})
                            {% endif %}
                        </p>
                    {% endwith %}
                {% empty %}
                    <div class="rpgui-center">
                        <p>There is no character for this game...</p>
                    </div>
                {% endfor %}
                <div class="rpgui-center">
                    <a href={% url 'game-invite-character' game.id %}>
                        <button class="rpgui-button"><p>Invite a character</p></button>
                    </a>
                </div>
            </div>

            {% if game.master.user == user %}
                <div id="master" class="rpgui-container framed-grey">
                    <h3>Master's panel</h3>
                    <div class="rpgui-center">
                        {% if game.is_under_preparation %}
                            <p>
                                <a href={% url 'game-start' game.id %}>
                                    <button class="rpgui-button"><p>Start the game</p></button>
                                </a>
                            </p>
                        {% elif game.is_ongoing %}
                            <p>
                                <a href={% url 'tale-create' game.id %}>
                                    <button class="rpgui-button"><p>Update the quest</p></button>
                                </a>
                            </p>
                            <p>
                                <a href={% url 'instruction-create' game.id %}>
                                    <button class="rpgui-button"><p>Give an instruction</p></button>
                                </a>
                            </p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="rpgui-center inline">
            <img class="rpgui-icon" style="transform: scaleX(-1)" src={% static 'images/mini-skull.png' %}>
            <a href="#title">- Back to top -</a>
            <img class="rpgui-icon" src={% static 'images/mini-skull.png' %}>
        </div>
    </div>
{% endblock %}
