{% extends 'base.html' %}
{% load static %}

{% block content %}

    <div class="game-layout">

    <!-- ══════════════════════════════════════════ -->
    <!-- LEFT: Game Log                             -->
    <!-- ══════════════════════════════════════════ -->
        <div class="game-log-col" id="game-log-col">
            {% include "game/partials/game_log_panel.html" %}
        </div>

    <!-- ══════════════════════════════════════════ -->
    <!-- RIGHT: Play Area                           -->
    <!-- ══════════════════════════════════════════ -->
        <div class="game-play-col">

        <!-- Quest section -->
            <div class="play-section">
                <div class="flex-between" style="margin-bottom: 8px;">
                    <span class="section-label">Quest</span>
                    {% if game.master.user == user and flow.is_ongoing %}
                        <a href="{% url 'quest-create' game.id %}" class="btn btn-ghost">Update Quest ▸</a>
                    {% endif %}
                </div>
                <div id="quest" style="white-space: pre-line; font-size: 14px; line-height: 1.6;">{{ quest.environment }}</div>
            </div>

            <hr class="divider">

        <!-- Messaging + player actions (ongoing games only) -->
            {% if flow.is_ongoing %}
                <div class="play-section" id="messaging">
                    <div style="display: flex; gap: 8px;">
                        <input id="message-input" type="text" placeholder="What do you do?" style="flex: 1;">
                        <button id="message-submit" class="btn btn-primary" type="button">Send</button>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button hx-get="{% url 'dice-roller-modal' game.id %}"
                                hx-target="body"
                                hx-swap="beforeend"
                                class="btn btn-ghost"
                                type="button">Roll Dice</button>
                        {% if game.master.user == user %}
                            <a href="{% url 'ability-check-request-create' game.id %}" class="btn btn-ghost">Ask for Ability Check</a>
                            <a href="{% url 'combat-create' game.id %}" class="btn btn-ghost">Initiate Combat</a>
                        {% endif %}
                        {% if player %}
                            {% if ability_check_request %}
                                <button id="ability-check-submit" class="btn btn-primary" type="button">Perform Ability Check</button>
                            {% endif %}
                            {% if saving_throw_request %}
                                <button id="saving-throw-submit" class="btn btn-primary" type="button">Perform Saving Throw</button>
                            {% endif %}
                            {% if combat_initiative_request %}
                                <button id="dexterity-check-submit" class="btn btn-primary" type="button">Roll Initiative</button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                <hr class="divider">
            {% endif %}

        <!-- Pre-game: DM start button -->
            {% if game.master.user == user and flow.is_under_preparation %}
                <div class="play-section">
                    <a href="{% url 'game-start' game.id %}" class="btn btn-primary">Start the Game</a>
                </div>
                <hr class="divider">
            {% endif %}

        <!-- Initiative Tracker (combat only) -->
            {% if combat %}
                <div class="play-section" id="initiative-section">
                    <div hx-get="{% url 'initiative-tracker' game.id combat.id %}"
                         hx-trigger="load, initiative-updated from:body"
                         hx-swap="innerHTML">
                    </div>
                </div>
                <hr class="divider">

        <!-- Action Panel (combat only) -->
                <div class="play-section" id="action-section">
                    <div hx-get="{% url 'action-panel' game.id combat.id %}"
                         hx-trigger="load, initiative-updated from:body, action-taken from:body"
                         hx-swap="innerHTML">
                    </div>
                </div>
                <hr class="divider">
            {% endif %}

        <!-- Characters -->
            <div class="play-section">
                <div class="flex-between" style="margin-bottom: 8px;">
                    <span class="section-label">Characters</span>
                    {% if game.master.user == user %}
                        <a href="{% url 'game-invite-user' game.id %}" class="btn btn-ghost">Invite a User ▸</a>
                    {% endif %}
                </div>
                {% for character in character_list %}
                    {% with character_user=character.user %}
                        <div style="padding: 4px 0;">
                            <a href="{{ character.get_absolute_url }}" style="color: var(--accent);">{{ character }}</a>
                            <span class="text-muted">
                                {% if character_user == user %}(played by you){% else %}({{ character_user }}){% endif %}
                            </span>
                        </div>
                    {% endwith %}
                {% empty %}
                    <p class="text-muted">No characters in this game yet.</p>
                {% endfor %}
            </div>

        </div><!-- /.game-play-col -->
    </div><!-- /.game-layout -->

    {% include "game/partials/keyboard_shortcuts_modal.html" %}
    {% include "game/partials/quick_reference_panels.html" %}

    <button id="shortcuts-help-btn"
            onclick="window.keyboardShortcuts && window.keyboardShortcuts.toggleHelp(event)"
            title="Keyboard shortcuts (?)">?</button>

    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const url = wsProtocol + window.location.host + '/events/' + {{ game.id }} + '/';

        const input = document.getElementById('message-input');
        const sendButton = document.getElementById('message-submit');
        const abilityCheckButton = document.getElementById('ability-check-submit');
        const dexterityCheckButton = document.getElementById('dexterity-check-submit');
        const savingThrowButton = document.getElementById('saving-throw-submit');

        const MESSAGE = "message";
        const QUEST_UPDATE = "quest.update";
        const ABILITY_CHECK_RESPONSE = "ability.check.response";
        const SAVING_THROW_RESPONSE = "saving.throw.response";
        const COMBAT_INITIATIVE_RESPONSE = "combat.initiative.response";
        const DICE_ROLL = "dice.roll";

        let eventsSocket = null;
        let reconnectAttempts = 0;
        const baseReconnectDelay = 1000;
        const maxReconnectDelay = 30000;
        let reconnectTimeout = null;

        const connectionStatus = (function() {
            const el = document.createElement('div');
            el.id = 'connection-status';
            el.title = 'Click to retry connection';
            el.addEventListener('click', function() {
                clearTimeout(reconnectTimeout);
                reconnectAttempts = 0;
                el.textContent = 'Reconnecting...';
                el.style.display = 'block';
                connectWebSocket();
            });
            document.body.appendChild(el);
            return el;
        })();

        function showConnectionStatus(message) {
            connectionStatus.textContent = message;
            connectionStatus.style.display = 'block';
        }

        function hideConnectionStatus() {
            connectionStatus.style.display = 'none';
        }

        function connectWebSocket() {
            if (eventsSocket && eventsSocket.readyState === WebSocket.OPEN) return;
            eventsSocket = new WebSocket(url);

            eventsSocket.onopen = function() {
                reconnectAttempts = 0;
                hideConnectionStatus();
                if (input) input.disabled = false;
                if (sendButton) sendButton.disabled = false;
            };

            eventsSocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                if (window.gameLog) window.gameLog.handleWebSocketEvent(message);

                if (message["type"] === QUEST_UPDATE) {
                    htmx.ajax('GET', window.location.pathname, {target: '#quest', swap: 'innerHTML'});
                } else if (message["type"] === MESSAGE || message["type"] === DICE_ROLL) {
                // handled by game log
                } else if (
                    message["type"].startsWith("turn.") ||
                    message["type"].startsWith("combat.") ||
                    message["type"].startsWith("hp.") ||
                    message["type"].startsWith("concentration.") ||
                    message["type"] === "action.taken"
                ) {
                    htmx.trigger(document.body, 'initiative-updated');
                } else {
                    location.reload();
                }
            };

            eventsSocket.onclose = function() { scheduleReconnect(); };
            eventsSocket.onerror = function() {};
        }

        function scheduleReconnect() {
            clearTimeout(reconnectTimeout);
            if (input) input.disabled = true;
            if (sendButton) sendButton.disabled = true;
            const delay = Math.min(
                baseReconnectDelay * Math.pow(2, reconnectAttempts) + Math.random() * 1000,
                maxReconnectDelay
            );
            reconnectAttempts++;
            showConnectionStatus('Reconnecting... (attempt ' + reconnectAttempts + ')');
            reconnectTimeout = setTimeout(connectWebSocket, delay);
        }

        function sendMessage(data) {
            if (eventsSocket && eventsSocket.readyState === WebSocket.OPEN) {
                eventsSocket.send(JSON.stringify(data));
                return true;
            }
            showConnectionStatus('Not connected. Reconnecting...');
            scheduleReconnect();
            return false;
        }

        connectWebSocket();

        if (sendButton) {
            sendButton.addEventListener('click', function() {
                const userInput = input.value.trim();
                if (userInput && sendMessage({'type': MESSAGE, 'date': Date.now(), 'username': '{{ user.username }}', 'message': userInput})) {
                    input.value = '';
                    input.focus();
                }
            });
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); sendButton.click(); }
            });
        }

        if (abilityCheckButton) {
            abilityCheckButton.addEventListener('click', function() {
                sendMessage({'type': ABILITY_CHECK_RESPONSE, 'date': Date.now(), 'username': '{{ user.username }}'});
            });
        }

        if (savingThrowButton) {
            savingThrowButton.addEventListener('click', function() {
                sendMessage({'type': SAVING_THROW_RESPONSE, 'date': Date.now(), 'username': '{{ user.username }}'});
            });
        }

        if (dexterityCheckButton) {
            dexterityCheckButton.addEventListener('click', function() {
                sendMessage({'type': COMBAT_INITIATIVE_RESPONSE, 'date': Date.now(), 'username': '{{ user.username }}'});
            });
        }

        if (input) input.focus();

    // Modal close handlers
        document.body.addEventListener('attack-modal-closed', function() {
            document.querySelectorAll('#attack-modal').forEach(m => m.remove());
            htmx.trigger(document.body, 'action-taken');
        });
        document.body.addEventListener('damage-applied', function() {
            document.querySelectorAll('#attack-modal').forEach(m => m.remove());
            htmx.trigger(document.body, 'initiative-updated');
        });
        document.body.addEventListener('dice-roller-closed', function() {
            document.querySelectorAll('#dice-roller-modal').forEach(m => m.remove());
        });
        document.body.addEventListener('concentration-modal-closed', function() {
            document.querySelectorAll('#concentration-save-modal').forEach(m => m.remove());
            htmx.trigger(document.body, 'initiative-updated');
        });

        document.addEventListener('click', function(e) {
            const modal = e.target;
            if (modal.classList && modal.classList.contains('rpg-modal') && modal.classList.contains('active')) {
                modal.classList.remove('active');
                const id = modal.id;
                if (id === 'attack-modal') htmx.trigger(document.body, 'attack-modal-closed');
                if (id === 'dice-roller-modal') htmx.trigger(document.body, 'dice-roller-closed');
                if (id === 'concentration-save-modal') htmx.trigger(document.body, 'concentration-modal-closed');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key !== 'Escape') return;
            ['attack-modal', 'dice-roller-modal', 'concentration-save-modal'].forEach(function(id) {
                const m = document.getElementById(id);
                if (m && m.classList.contains('active')) {
                    m.classList.remove('active');
                    const events = {
                        'attack-modal': 'attack-modal-closed',
                        'dice-roller-modal': 'dice-roller-closed',
                        'concentration-save-modal': 'concentration-modal-closed'
                    };
                    htmx.trigger(document.body, events[id]);
                }
            });
        });
    </script>

    <script src="{% static 'js/keyboard-shortcuts.js' %}"></script>

{% endblock %}
